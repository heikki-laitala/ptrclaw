name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  pull-requests: write

jobs:
  build-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: g++ meson ninja-build libssl-dev libsqlite3-dev lld
          version: 1.0

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install meson sqlite3

      - name: Cache build
        uses: actions/cache@v4
        with:
          path: builddir
          key: meson-${{ matrix.os }}-${{ hashFiles('meson.build', 'src/**/*.cpp', 'src/**/*.hpp') }}
          restore-keys: meson-${{ matrix.os }}-

      - name: Build
        run: make build

      - name: Test
        run: make test

      - name: Job summary
        if: always()
        run: |
          echo "## ptrClaw CI â€” ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY

          if [ -f builddir/meson-logs/testlog.txt ]; then
            PASS=$(grep -c '^OK' builddir/meson-logs/testlog.txt || true)
            FAIL=$(grep -c '^FAIL' builddir/meson-logs/testlog.txt || true)
            echo "| Tests passed | ${PASS:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| Tests failed | ${FAIL:-0} |" >> $GITHUB_STEP_SUMMARY
          fi

          BIN=builddir/ptrclaw
          if [ -f "$BIN" ]; then
            SIZE=$(wc -c < "$BIN" | tr -d ' ')
            SIZE_HR=$(awk "BEGIN {printf \"%.1f MB\", $SIZE / 1048576}")
            echo "| Binary | ${SIZE_HR} (${SIZE} bytes) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload binary
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ptrclaw-${{ matrix.os == 'ubuntu-latest' && 'linux-x86_64' || 'macos-aarch64' }}
          path: builddir/ptrclaw

  lint:
    name: Lint (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: g++ meson ninja-build libssl-dev libsqlite3-dev clang-tidy lld
          version: 1.0

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install meson llvm sqlite3

      - name: Cache build
        uses: actions/cache@v4
        with:
          path: builddir
          key: meson-${{ matrix.os }}-${{ hashFiles('meson.build', 'src/**/*.cpp', 'src/**/*.hpp') }}
          restore-keys: meson-${{ matrix.os }}-

      - name: Build
        run: make build

      - name: Lint (changed files on PR)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin main --depth=1
          CHANGED=$(git diff --name-only --diff-filter=d origin/main...HEAD -- '*.cpp' '*.hpp' | grep -E '^(src|tests)/' | tr '\n' ' ')
          if [ -n "$CHANGED" ]; then
            if [ "$(uname)" = "Darwin" ]; then
              CLANG_TIDY_EXTRA="-extra-arg=-stdlib=libc++ -extra-arg=-isysroot$(xcrun --show-sdk-path)"
            else
              CLANG_TIDY_EXTRA=""
            fi
            clang-tidy -p builddir $CLANG_TIDY_EXTRA $CHANGED 2>&1 | grep -v 'warnings generated'
          else
            echo "No changed src/tests files to lint"
          fi

      - name: Lint (all files on main)
        if: github.event_name == 'push'
        run: make lint

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: g++ meson ninja-build libssl-dev libsqlite3-dev lld gcovr
          version: 1.0

      - name: Coverage
        run: |
          meson setup builddir-cov --native-file meson-native-linux.ini -Db_coverage=true -Dcatch2:tests=false
          meson test -C builddir-cov
          gcovr -x --root . builddir-cov --filter src/ > coverage.xml

      - name: Coverage report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage.xml
          format: markdown
          output: both

      - name: Job summary
        run: |
          if [ -f code-coverage-results.md ]; then
            cat code-coverage-results.md >> $GITHUB_STEP_SUMMARY
          fi
