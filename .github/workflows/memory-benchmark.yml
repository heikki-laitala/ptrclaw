name: Memory Benchmark

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  benchmark:
    name: memory-benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secret exists
        shell: bash
        run: |
          if [ -z "${ANTHROPIC_API_KEY}" ]; then
            echo "Missing required secret: ANTHROPIC_API_KEY"
            exit 1
          fi
          echo "::add-mask::${ANTHROPIC_API_KEY}"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ meson ninja-build libssl-dev libsqlite3-dev lld
          pip install anthropic

      - name: Build
        run: |
          meson setup builddir --buildtype=release -Dwith_pipe=true
          meson compile -C builddir

      - name: Run memory benchmark
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p benchmark-results
          python3 tests/e2e/memory_benchmark.py ./builddir/ptrclaw \
            --output benchmark-results/results.json \
            2> >(tee benchmark-results/benchmark.log >&2)

      - name: Redact secrets from logs
        if: always()
        run: |
          if [ -d benchmark-results ]; then
            find benchmark-results -type f -exec \
              sed -i -E 's/sk-ant-[A-Za-z0-9_-]+/***REDACTED***/g' {} +
          fi

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memory-benchmark-results
          path: benchmark-results/
          if-no-files-found: ignore
